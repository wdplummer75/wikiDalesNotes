"use strict";(function($){var instrument;$.editable&&($.editable.addInputType("datepicker",{element:function(e){var t=$("<input>");return"none"!==e.width&&t.width(e.width),"none"!==e.height&&t.height(e.height),t.prop("autocomplete",!1),$(this).append(t),t},plugin:function(e,t){var a=this;e.onblur="ignore";var n=$(this).find("input"),r=new Calendar(1,null,(function(e,t){e.dateClicked&&(e.hide(),n.val(t),$(a).trigger("submit"))}),(function(n){n.hide(),t.reset.apply(t,[a]),$(t).addClass(e.cssdecoration)}));r.showsOtherMonths=!0,r.setRange(1900,2070),r.create(),e.format&&(r.showsTime=-1!==e.format.search(/%H|%I|%k|%l|%M|%p|%P/),r.setDateFormat(e.format),r.setTtDateFormat(e.format)),r.parseDate(t.revert.replace(/^\s+/,"")),r.showAtElement(n[0],"Br")}}),$.editable.addInputType("radio",{element:function(e){var t=$('<input type="hidden" id="'+e.name+'" name="'+e.name+'" value="" />');$(this).append(t);var a,n,r,i,o=1;for(a in e.data)i=e.name+"_button"+o,$(this).append('<label for="'+i+'">'+e.data[a]+"</label>"),r=a===e.text?' checked="checked"':"",n=$('<input type="radio" name="'+e.name+'_buttons" id="'+i+'"'+r+' value="'+a+'" />'),$(this).append(n),n.on("click",(function(){$("#"+e.name).val($(this).val())})),o++;return t}}),$.editable.addInputType("erpselect",{element:function(){var e=$("<select />");return $(this).append(e),e},content:function(data,settings,original){if(console.debug("content"),"string"==typeof data)eval("var json = "+data);else var json=data;for(var i in json.order){var key=json.order[i];if(null!=json.keys[key]){var option=$("<option />").val(key).append(json.keys[key]);$("select",this).append(option)}}$("select",this).children().each((function(){$(this).val()!==json.selected&&$(this).text()!==$.trim(original.revert)||$(this).prop("selected",!0)}))}}),$.editable.addInputType("checkbox",{element:function(e){var t=$('<input type="hidden" id="'+e.name+'" name="'+e.name+'" value="" />');$(this).append(t);var a,n,r,i,o=1,s=new RegExp("\\b("+e.text.replace(/\s*,\s*/,"|")+")\\b");for(a in e.data)i=e.name+"_button"+o,r=s.test(a)?' checked="checked"':"",n=$('<input type="checkbox" name="'+e.name+'_buttons" id="'+i+'"'+r+' value="'+a+'" />'),$(this).append(n),$(this).append('<label for="'+i+'">'+e.data[a]+"</label>"),n.on("change",(function(){var t='input[name="'+e.name+'_buttons"]',a=[];$(t).each((function(e,t){$(t).attr("checked")&&a.push($(t).val())})),$("#"+e.name).val(a.join(","))})),o++;return t}}));var onDrop=function(e,t,a,n){var r,i,o,s=$(e.target);s.hasClass("drag-helper")?(o=n.first().offset().top,i=e.pageY-o,r=i<(n.last().offset().top()+n.last().height()-o)/2?"top":"bottom",s="top"===r?n.first():n.last()):(i=e.pageY-s.offset().top,r=i<s.height()/2?"top":"bottom");var d,l=s.data("erp-data"),c=a.data("erp-data").row;d=null!=l?l.row:s.next().size()>0?0:s.parent().children().size();var p=t.closest("table"),f=$.extend({noredirect:1},l);if($.each(p.data("erp-data"),(function(e,t){f["erp_"+e]=t})),"bottom"===r&&d++,d!==c){a.fadeTo("slow",0),t.css("cursor","wait"),f.erp_action="moveRowCmd",f.old_pos=c,f.new_pos=d,null==f.erp_row&&(f.erp_row=c),f.erp_stop_edit=1,$('input[name="validation_key"]').first().each((function(){var e=$(this);e.closest("form").each((function(){"undefined"!=typeof StrikeOne&&StrikeOne.submit(this)})),f.validation_key=e.val()})),p.css("cursor","wait");var u=p.attr("id");u||(u="table"+Date.now(),p.attr("id",u)),$.ajax({url:foswiki.getPreference("SCRIPTURLPATH")+"/rest/EditRowPlugin/save",type:"POST",data:f,success:function(e){var n=$("#"+u);if(0!==e.indexOf("RESPONSE"))t.replaceWith($(e).find("form[name='loginform']")),$("form[name='loginform'] input[name='noredirect']").remove();else{var i=$(e.replace(/^RESPONSE/,""));i.addClass("erp_new_table"),n.replaceWith(i),$(document).find(".erp_new_table").each((function(){$(this).removeClass("erp_new_table"),instrument($(this))}))}"top"===r?a.insertBefore(s):a.insertAfter(s),n.css("cursor","auto")},error:function(e){a.fadeTo("fast",1),$("#"+u).css("cursor","auto");var t=e.responseText;t=t&&0===t.indexOf("RESPONSE")?t.replace(/^RESPONSE/,": "):"",alert("Error "+e.status+" - Failed to move row"+t)}})}},dragHelper=function(e){var t=e.clone();return $("<div><table></table></div>").find("table").append(t.addClass("drag-helper")).end()},makeRowDraggable=function(e){var t=e.closest("thead,tbody,tfoot,table");e.find("td, th").first().each((function(){var a=$("<a href='#' class='erp_drag_button ui-icon-arrow-2-n-s ui-icon' title='Click and drag to move row'>move</a>"),n=$("<div class='erpJS_container' style='display: inline-block; width: 0em;'></div>");n.append(a),$(this).prepend(n),a.draggable({containment:t,axis:"y",appendTo:t,helper:function(){return dragHelper(e)},start:function(){e.fadeTo("fast",.3);var a=t.find("tr");a.not(e).not(".drag-helper").droppable({drop:function(n){onDrop(n,t,e,a)}})},stop:function(){e.fadeTo("fast",1)}})}))},editControls={onedit:function(e,t){$(t).next().hide()},submitdata:function(){var e=$.extend({action:"saveCellCmd"},$(this).data("erp-data"),$(this).closest("tr").data("erp-data"),$(this).closest("table").data("erp-data")),t={};return $.each(e,(function(e,a){t["erp_"+e]=a})),t.noredirect=1,$(this).closest("form").each((function(){"undefined"!=typeof StrikeOne&&StrikeOne.submit(this),$(this).find('input[name="validation_key"]').each((function(){t.validation_key=$(this).val()}))})),t},onsubmit:function(e,t){return!t.isSubmitting&&(t.isSubmitting=!0,$("<div class='erp-clock'></div>").insertAfter($(t).next()),!0)},onreset:function(e,t){return $(t).next().show(),!0},onerror:function(e,t,a){var n=a.responseText;t.isSubmitting=!1,$(t).parent().find(".erp-clock").remove(),$(t).next().show(),0===n.indexOf("RESPONSE")&&alert(n.replace(/^RESPONSE/,""))},onblur:"cancel"},editCallback=function(e,t,a,n){t=t.replace(/^RESPONSE/,""),$(e).html(t),n&&(a.data=t),e.isSubmitting=!1,$(e).parent().find(".erp-clock").remove(),$(e).next().show()},textCallback=function(e,t){editCallback(this,e,t,!0)},otherCallback=function(e,t){editCallback(this,e,t,!1)},onSaveComplete=function(e,t){var a=e.getResponseHeader("X-Foswiki-Validation");a&&$("input[name='validation_key']").each((function(){$(this).val("?"+a)})),"success"!==t&&alert(e.responseText)},attachJEditable=function(e){var t=e.data("erp-data");if(t&&t.type&&"label"!==t.type){var a=$("<div class='erpJS_container'></div>"),n=$('<div class="erp-edit-button" title="Click to edit"></div>');a.append(n),e.closest("td, th").prepend(a),n.on("click",(function(){e.triggerHandler("erp_edit")})),t=$.extend({event:"erp_edit",placeholder:'<div class="erp_empty"></div>',callback:"text"===t.type||"textarea"===t.type?textCallback:otherCallback,tooltip:"",ajaxoptions:{complete:onSaveComplete}},t,editControls);var r=foswiki.getPreference("SCRIPTURLPATH")+"/rest/EditRowPlugin/save";e.editable&&e.editable(r,t)}},erp_dataDirty=!1,erp_dirtyVeto=!1,repair_table=function(e,t){var a,n;if(t){void 0!==t.headerrows?a=t.headerrows:t.TABLE&&void 0!==t.TABLE.headerrows&&(a=t.TABLE.headerrows),void 0!==t.footerrows?n=t.footerrows:t.TABLE&&void 0!==t.TABLE.footerrows&&(n=t.TABLE.footerrows);var r=e.children("tbody");if(0!==r.length){if(a>0){var i=e.children("thead");for(0===i.length&&(i=$("<thead></thead>")).prependTo(e);i.children().length<a;)if(r.children().length>0)r.children().first().detach().appendTo(i);else{if(!(o.children().length>0))break;o.children().first().detach().appendTo(i)}}if(n>0){var o=e.children("tfoot");for(0===o.length&&(o=$("<tfoot></tfoot>")).appendTo(e);o.children().length<n&&r.children().length>0;)r.children().last().detach().prependTo(o)}}}};instrument=function(e){e.find(".erpJS_cell").each((function(){var e=$(this).data("erp-tabledata");if(e){var t=$(this).closest("table");t.data("erp-data",e),repair_table(t,e),t.addClass("erp_editable")}if(e=$(this).data("erp-trdata")){var a=$(this).closest("tr");a.data("erp-data",e),a.addClass("ui-draggable")}})),e.find(".interactive_sort").first().each((function(){var e=$(this).data("sort");$(this).closest("table").data("sort",e).find(".tableSortIcon").remove()})),e.find(".erpJS_input").on("change",(function(){erp_dataDirty=!0})),e.find("a.erpJS_willDiscard").on("click",(function(){return!(erp_dataDirty&&!confirm("This action will discard your changes."))||(erp_dirtyVeto=!0,!1)})),(!$.browser.msie||parseInt($.browser.version)>=8)&&e.find("a.erpJS_submit").button(),e.find("a.erpJS_submit").on("click",(function(){var e=!0;if(erp_dirtyVeto)erp_dirtyVeto=!1,e=!1;else{var t=$(this).closest("form");t&&t.length>0&&(t[0].erp_action.value=$(this).attr("href"),t.trigger("submit"),e=!1)}return e})),$(".interactive_sort",e).on("click",(function(){return sortTable(this,$(this).data("sort")),!1})).each((function(){$(this).addClass("erpJS_sort")})),$("table.erp_editable",e).find(".foswikiSortedCol").find(".interactive_sort").each((function(){var e=$(this);e.parent("a").each((function(){e.unwrap()})),e.closest("table").find(".tableSortIcon").remove();var t=e.data("sort");$("<div></div>").addClass("tableSortIcon ui-icon erp-button ui-icon-circle-triangle-"+(t&&1===t.reverse?"s":"n")).attr("title","Sorted "+(t&&1===t.reverse?"descending":"ascending")).appendTo(e.closest("td,th"))}));var t=null;$(".ui-draggable").on("mouseover",(function(){var e=$(this);e.is(".erp_instrumented")||(e.addClass("erp_instrumented"),e.closest("tbody,table").children().length>1&&makeRowDraggable(e),e.find(".erpJS_cell").each((function(){attachJEditable($(this))}))),t&&e[0]===t[0]||(t&&t.find(".erpJS_container").fadeOut("fast"),e.find(".erp_drag_button,.erpJS_container").fadeIn("fast"),t=e)}))},$.ajaxSetup({error:function(e){401===e.status&&alert("Please log in before editing")}}),$((function(){instrument($(document))}))})(jQuery);
